#!/bin/bash -e

# get the secret generated by cross plane
if [ -z "$1" ]; then
 echo "first arg should be the secret name"
 exit 1
fi
CROSSPLANE_SECRET=$1

# require a namespace to be given
if [ -z "$2" ]; then
 echo "second arg should be the namespace name that hosts the secret"
 exit 1
fi
NAMESPACE=$2

# extract connection details from cross plane generated secret
POSTGRES_USER=$(kubectl get secret $CROSSPLANE_SECRET -n $NAMESPACE --output 'jsonpath={.data.username}' | base64 --decode)
POSTGRES_PASSWORD=$(kubectl get secret $CROSSPLANE_SECRET -n $NAMESPACE --output 'jsonpath={.data.password}' | base64 --decode)
POSTGRES_ENDPOINT=$(kubectl get secret $CROSSPLANE_SECRET -n $NAMESPACE --output 'jsonpath={.data.endpoint}' | base64 --decode)
POSTGRES_PORT=$(kubectl get secret $CROSSPLANE_SECRET -n $NAMESPACE --output 'jsonpath={.data.port}' | base64 --decode)

echo "
---
apiVersion: v1
kind: Secret
metadata:
  name: \"$CROSSPLANE_SECRET-service-binding-compatible\"
  namespace: $NAMESPACE
type: Opaque
stringData:
  type: postgresql
  provider: gcp
  host: \"$POSTGRES_ENDPOINT\"
  port: \"$POSTGRES_PORT\"
  database: \"postgres\"
  username: \"$POSTGRES_USER\"
  password: \"$POSTGRES_PASSWORD\"
"
